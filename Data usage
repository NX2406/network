#!/bin/bash

# ==================================================
# æµé‡æ¶ˆè€—/å¾ªç¯æµ‹é€Ÿè„šæœ¬ v4.0 (å¤šèŠ‚ç‚¹è½®è¯¢ç‰ˆ)
# ==================================================

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
SKYBLUE='\033[0;36m'
BLUE='\033[0;34m'
NC='\033[0m'

# ç´¯è®¡æ¶ˆè€—æµé‡å˜é‡ (å•ä½: MB)
TOTAL_MB=0

# æ•è· Ctrl+C
trap 'echo -e "\n${RED}[!] è„šæœ¬å·²åœæ­¢ã€‚æœ¬æ¬¡è¿è¡Œå…±æ¶ˆè€—æµé‡ï¼š$(awk "BEGIN {print $TOTAL_MB/1024}") GB${NC}"; exit 1' INT

# ä¾èµ–æ£€æŸ¥
check_dep() {
    if ! command -v wget &> /dev/null; then
        echo -e "${YELLOW}æ­£åœ¨å®‰è£… wget...${NC}"
        if [ -f /etc/debian_version ]; then apt-get install -y wget; 
        elif [ -f /etc/redhat-release ]; then yum install -y wget; fi
    fi
    if ! command -v speedtest-cli &> /dev/null; then
        echo -e "${YELLOW}æ­£åœ¨å®‰è£… speedtest-cli...${NC}"
        pip3 install speedtest-cli 2>/dev/null || apt-get install -y speedtest-cli 2>/dev/null || yum install -y speedtest-cli 2>/dev/null
    fi
}

# æ ¼å¼åŒ–æ˜¾ç¤ºæµé‡ (MB -> GB)
display_status() {
    clear
    # è®¡ç®— GB
    TOTAL_GB=$(awk "BEGIN {printf \"%.2f\", $TOTAL_MB/1024}")
    
    echo -e "${BLUE}#################################################${NC}"
    echo -e "${BLUE}#            æµé‡æ¶ˆè€—æŒ‚æœºè„šæœ¬ v4.0              #${NC}"
    echo -e "${BLUE}#################################################${NC}"
    echo -e ""
    echo -e "   ğŸš€ ${GREEN}å½“å‰æ¨¡å¼:${NC} $1"
    echo -e "   ğŸ“Š ${YELLOW}å·²æ¶ˆè€—æ€»æµé‡:${NC} ${RED}${TOTAL_GB} GB${NC}"
    echo -e "   â±ï¸  ${SKYBLUE}è¿è¡ŒçŠ¶æ€:${NC} æ­£åœ¨è¿è¡Œä¸­..."
    echo -e ""
    echo -e "${BLUE}-------------------------------------------------${NC}"
}

# å®šä¹‰ä¸‹è½½èŠ‚ç‚¹åº“ (ç²¾é€‰å…¨çƒå¤§å¸¦å®½æµ‹é€Ÿæº)
# æ ¼å¼ï¼šURL|æ–‡ä»¶å¤§å°(MB)
NODES=(
    "http://mirror.leaseweb.com/speedtest/1000mb.bin|1000"     # Leaseweb (é€šå¸¸æœ€å¿«)
    "http://speedtest.tele2.net/1GB.zip|1024"                 # Tele2 (æ¬§æ´²è€ç‰Œ)
    "http://ipv4.download.thinkbroadband.com/1GB.zip|1024"    # ThinkBroadband
    "http://speedtest-nyc1.digitalocean.com/5gb.test|5120"    # DigitalOcean (ç¾å›½)
    "http://speedtest.london.linode.com/100MB-london.bin|100" # Linode (è‹±å›½)
    "http://speedtest.tokyo2.linode.com/100MB-tokyo2.bin|100" # Linode (æ—¥æœ¬)
    "https://fsn1-speed.hetzner.com/1GB.bin|1000"             # Hetzner (å¾·å›½)
    "http://speedtest.fremont.linode.com/100MB-fremont.bin|100" # Linode (ç¾è¥¿)
)

# éšæœºè·å–ä¸€ä¸ªèŠ‚ç‚¹
get_random_node() {
    RANDOM_INDEX=$((RANDOM % ${#NODES[@]}))
    NODE_INFO="${NODES[$RANDOM_INDEX]}"
    NODE_URL="${NODE_INFO%%|*}"
    NODE_SIZE="${NODE_INFO##*|}"
}

# 1. å¦‚ä¸‹è¡Œ (éšæœºèŠ‚ç‚¹å¾ªç¯)
run_download() {
    while true; do
        display_status "åªè·‘ä¸‹è¡Œ (Download)"
        get_random_node
        
        echo -e "æ­£åœ¨è¿æ¥èŠ‚ç‚¹: ${SKYBLUE}$NODE_URL${NC}"
        echo -e "æ–‡ä»¶å¤§å°é¢„è®¡: ${YELLOW}$NODE_SIZE MB${NC}"
        
        # æ ¸å¿ƒä¸‹è½½å‘½ä»¤
        # --timeout=10: è¶…æ—¶æ—¶é—´10ç§’ï¼Œé˜²æ­¢å¡æ­»
        # --tries=2: å¤±è´¥é‡è¯•2æ¬¡
        wget -O /dev/null --user-agent="Mozilla/5.0" --show-progress --timeout=10 --tries=2 "$NODE_URL"
        
        # æ£€æŸ¥ wget é€€å‡ºçŠ¶æ€
        if [ $? -eq 0 ]; then
            TOTAL_MB=$((TOTAL_MB + NODE_SIZE))
            echo -e "${GREEN}ä¸‹è½½å®Œæˆï¼Œæµé‡å·²è®°å½•ã€‚${NC}"
        else
            echo -e "${RED}[!] å½“å‰èŠ‚ç‚¹è¿æ¥å¤±è´¥æˆ–è¶…æ—¶ï¼Œè‡ªåŠ¨åˆ‡æ¢ä¸‹ä¸€ä¸ª...${NC}"
            sleep 2
        fi
        
        sleep 1
    done
}

# 2. è·‘ä¸Šè¡Œ
run_upload() {
    while true; do
        display_status "åªè·‘ä¸Šè¡Œ (Upload)"
        echo -e "${YELLOW}æ­£åœ¨æ‰§è¡Œ Speedtest ä¸Šä¼ æµ‹è¯•...${NC}"
        speedtest-cli --no-download --secure
        if [ $? -eq 0 ]; then
            echo -e "\n${GREEN}ä¸Šä¼ æµ‹è¯•å®Œæˆ${NC}"
            # ä¼°ç®—æ¯æ¬¡ä¸Šä¼ æ¶ˆè€— 60MB (è§†å¸¦å®½è€Œå®šï¼Œä»…åšå‚è€ƒ)
            TOTAL_MB=$((TOTAL_MB + 60))
        else
            echo -e "${RED}[!] Speedtest è¿æ¥å¤±è´¥ï¼Œé‡è¯•ä¸­...${NC}"
        fi
        sleep 2
    done
}

# 3. æ··åˆæ¨¡å¼
run_both() {
    while true; do
        display_status "æ··åˆåŒæ‰“ (Down+Up)"
        
        # ä¸‹è½½éƒ¨åˆ†
        get_random_node
        echo -e "${SKYBLUE}[1/2] æ­£åœ¨ä¸‹è½½ (${NODE_SIZE}MB)...${NC}"
        wget -O /dev/null --user-agent="Mozilla/5.0" --show-progress --timeout=10 --tries=1 "$NODE_URL"
        if [ $? -eq 0 ]; then TOTAL_MB=$((TOTAL_MB + NODE_SIZE)); fi
        
        # ä¸Šä¼ éƒ¨åˆ†
        echo -e "\n${SKYBLUE}[2/2] æ­£åœ¨ä¸Šä¼ ...${NC}"
        speedtest-cli --secure
        TOTAL_MB=$((TOTAL_MB + 60))
        
        sleep 3
    done
}

# èœå•
main() {
    check_dep
    clear
    echo -e "=================================="
    echo -e "   æµé‡æ¶ˆè€—æŒ‚æœºè„šæœ¬ v4.0 (Pro)"
    echo -e "=================================="
    echo -e "1. ${GREEN}åªè·‘ä¸‹è¡Œ${NC} (æ¨è, å¤šèŠ‚ç‚¹éšæœºè½®è¯¢)"
    echo -e "2. ${GREEN}åªè·‘ä¸Šè¡Œ${NC} (Speedtest)"
    echo -e "3. ${GREEN}æ··åˆå¾ªç¯${NC}"
    echo -e "0. é€€å‡º"
    echo -e "=================================="
    read -p "è¯·é€‰æ‹© [1-3]: " choice

    case $choice in
        1) run_download ;;
        2) run_upload ;;
        3) run_both ;;
        0) exit 0 ;;
        *) main ;;
    esac
}

main
