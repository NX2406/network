#!/bin/bash

# ==================================================
# æµé‡æ¶ˆè€—/æµ‹é€Ÿè„šæœ¬ v9.0 (å…¨çƒCDN/Anycastç‰ˆ)
# ==================================================

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
SKYBLUE='\033[0;36m'
BLUE='\033[0;34m'
NC='\033[0m'

# çº¿ç¨‹æ•° (Axel)
THREADS=8
# ç´¯è®¡æ¶ˆè€—æµé‡ (MB)
TOTAL_MB=0

# æ•è· Ctrl+Cï¼Œå¼ºåˆ¶æ¸…ç†ç¼“å­˜æ–‡ä»¶
trap 'echo -e "\n${RED}[!] è„šæœ¬å·²åœæ­¢ã€‚æœ¬æ¬¡è¿è¡Œå…±æ¶ˆè€—æµé‡ï¼š$(awk "BEGIN {print $TOTAL_MB/1024}") GB${NC}"; rm -f *.st; exit 1' INT

# ====================
# 1. ä¾èµ–æ£€æŸ¥
# ====================
check_dep() {
    if ! command -v axel &> /dev/null; then
        echo -e "${YELLOW}æ­£åœ¨å®‰è£… axel (å¤šçº¿ç¨‹ä¸‹è½½å™¨)...${NC}"
        if [ -f /etc/debian_version ]; then 
            apt-get update -y -q && apt-get install -y axel
        elif [ -f /etc/redhat-release ]; then
            yum install -y epel-release && yum install -y axel
        fi
    fi
    if ! command -v speedtest-cli &> /dev/null; then
        pip3 install speedtest-cli 2>/dev/null || apt-get install -y speedtest-cli 2>/dev/null
    fi
}

# ====================
# 2. é¡¶çº§éª¨å¹²ç½‘èŠ‚ç‚¹ (Anycast)
# ====================
# è¿™äº›èŠ‚ç‚¹ç”±å…¨çƒCDNæ‰˜ç®¡ï¼Œè‡ªåŠ¨è·¯ç”±åˆ°æœ€è¿‘èŠ‚ç‚¹ï¼Œæå°‘å¤±æ•ˆ
NODES=(
    "CDN77 (Global)|https://test.cdn77.com/1000MB.zip|1000"
    "Cachefly (Global)|http://cachefly.cachefly.net/100mb.test|100"
    "Hetzner (Europe)|https://fsn1-speed.hetzner.com/1GB.bin|1000"
    "Lancom (Global)|https://speedtest.lancom.de/1GB.bin|1000"
)

display_status() {
    clear
    TOTAL_GB=$(awk "BEGIN {printf \"%.2f\", $TOTAL_MB/1024}")
    echo -e "${BLUE}#################################################${NC}"
    echo -e "${BLUE}#         æµé‡æ¶ˆè€—è„šæœ¬ v9.0 (CDN ç¨³å®šç‰ˆ)        #${NC}"
    echo -e "${BLUE}#################################################${NC}"
    echo -e "   ğŸš€ ${GREEN}å½“å‰æ¨¡å¼:${NC} $1"
    echo -e "   ğŸ”— ${GREEN}æ­£åœ¨è¿æ¥:${NC} ${SKYBLUE}$CURRENT_NODE_NAME${NC}"
    echo -e "   ğŸ“Š ${YELLOW}å·²è·‘æµé‡:${NC} ${RED}${TOTAL_GB} GB${NC}"
    echo -e "   âš¡ ${YELLOW}å®æ—¶é€Ÿåº¦:${NC} è¯·çœ‹ä¸‹æ–¹è¿›åº¦æ¡"
    echo -e "${BLUE}-------------------------------------------------${NC}"
}

# ====================
# 3. æ ¸å¿ƒæ‰§è¡Œé€»è¾‘
# ====================
run_download() {
    while true; do
        # è½®è¯¢åˆ—è¡¨ä¸­çš„èŠ‚ç‚¹
        for node in "${NODES[@]}"; do
            CURRENT_NODE_NAME=$(echo "$node" | cut -d'|' -f1)
            url=$(echo "$node" | cut -d'|' -f2)
            size=$(echo "$node" | cut -d'|' -f3)

            display_status "å¤šçº¿ç¨‹ä¸‹è¡Œ (Global CDN)"

            # æ¸…ç†æ—§ç¼“å­˜ï¼Œé˜²æ­¢ No state file æŠ¥é”™
            rm -f *.st
            
            # --- æ ¸å¿ƒä¿®æ”¹ï¼šä¼ªè£… User-Agent ---
            # -H: æ·»åŠ  Header
            # -n: çº¿ç¨‹æ•°
            # -k: ä¸æ£€æŸ¥è¯ä¹¦ (é˜²æ­¢è€æ—§ç³»ç»Ÿè¯ä¹¦æŠ¥é”™)
            # -o: è¾“å‡ºåˆ°ç©ºè®¾å¤‡
            # --timeout: 10ç§’è¶…æ—¶
            axel -n $THREADS -a -k -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64)" -o /dev/null --timeout=10 "$url"
            
            exit_code=$?
            
            # åªæœ‰æˆåŠŸ(0)æ‰è®¡å…¥æµé‡
            if [ $exit_code -eq 0 ]; then
                TOTAL_MB=$((TOTAL_MB + size))
                echo -e "${GREEN} >> ä¸‹è½½å®Œæˆï¼Œå‡†å¤‡ä¸‹ä¸€è½®...${NC}"
                sleep 1
            else
                # å¤±è´¥å¤„ç†
                echo -e "${RED} >> å½“å‰èŠ‚ç‚¹è¿æ¥ä¸­æ–­æˆ–è¶…æ—¶ï¼Œè‡ªåŠ¨åˆ‡æ¢ä¸‹ä¸€ä¸ª...${NC}"
                sleep 1
            fi
            
            # å†æ¬¡å¼ºåˆ¶æ¸…ç†
            rm -f *.st
        done
    done
}

run_both() {
    while true; do
        # ä¸‹è¡Œéƒ¨åˆ† (åªè·‘åˆ—è¡¨ç¬¬ä¸€ä¸ªï¼Œé€šå¸¸æ˜¯æœ€å¿«çš„ CDN77)
        node="${NODES[0]}" 
        CURRENT_NODE_NAME=$(echo "$node" | cut -d'|' -f1)
        url=$(echo "$node" | cut -d'|' -f2)
        size=$(echo "$node" | cut -d'|' -f3)
        
        display_status "æ··åˆæ¨¡å¼ (Down+Up)"
        
        rm -f *.st
        axel -n $THREADS -a -k -H "User-Agent: Mozilla/5.0" -o /dev/null --timeout=10 "$url"
        if [ $? -eq 0 ]; then TOTAL_MB=$((TOTAL_MB + size)); fi
        rm -f *.st
        
        echo -e "\n${SKYBLUE}[2/2] æ­£åœ¨ä¸Šä¼  (Speedtest)...${NC}"
        speedtest-cli --secure
        TOTAL_MB=$((TOTAL_MB + 50))
        sleep 2
    done
}

# ====================
# 4. èœå•
# ====================
main() {
    clear
    check_dep
    rm -f *.st # å¯åŠ¨å‰æ¸…ç†æ®‹æ¸£
    
    echo -e "================================================="
    echo -e "   æµé‡æ¶ˆè€—è„šæœ¬ v9.0 (Global CDN Edition)"
    echo -e "================================================="
    echo -e "1. ${GREEN}å¤šçº¿ç¨‹è·‘ä¸‹è¡Œ${NC} (æ¨è! ä½¿ç”¨å…¨çƒ CDN éª¨å¹²ç½‘)"
    echo -e "2. ${GREEN}æ··åˆè·‘æµé‡${NC} (ä¸‹è¡Œ + ä¸Šè¡Œ)"
    echo -e "3. ${GREEN}åªè·‘ä¸Šè¡Œ${NC} (Speedtest)"
    echo -e "0. é€€å‡º"
    echo -e "================================================="
    read -p "é€‰æ‹© [1-3]: " choice

    case $choice in
        1) run_download ;;
        2) run_both ;;
        3) 
           CURRENT_NODE_NAME="Speedtest Upload"
           while true; do
               display_status "åªè·‘ä¸Šè¡Œ"
               speedtest-cli --no-download --secure
               TOTAL_MB=$((TOTAL_MB + 50))
               sleep 1
           done 
           ;;
        0) exit 0 ;;
        *) main ;;
    esac
}

main
