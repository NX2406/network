#!/bin/bash

# ==================================================
# 流量消耗脚本 v10.0 (DNS暴力修复 + 多进程并发版)
# ==================================================

# 颜色
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# 累计流量 (估算)
TOTAL_GB=0
# 并发进程数 (等于多线程)
CONCURRENT_NUM=4

# 捕获 Ctrl+C，杀掉所有后台下载进程
trap 'echo -e "\n${RED}[!] 停止脚本，正在清理后台进程...${NC}"; kill $(jobs -p) 2>/dev/null; exit 1' INT

# ====================
# 1. 暴力修复 DNS (核心修复)
# ====================
fix_dns() {
    echo -e "${YELLOW}[*] 检测到可能的 DNS 故障，正在强制修复 DNS...${NC}"
    # 备份原文件
    cp /etc/resolv.conf /etc/resolv.conf.bak 2>/dev/null
    # 写入 Google DNS
    echo "nameserver 8.8.8.8" > /etc/resolv.conf
    echo "nameserver 1.1.1.1" >> /etc/resolv.conf
    
    # 测试一下能不能通
    ping -c 1 -W 1 google.com > /dev/null 2>&1
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}[+] DNS 修复成功，网络已通！${NC}"
    else
        echo -e "${RED}[!] DNS 修复失败，您的服务器可能被防火墙完全阻断！${NC}"
    fi
}

check_dep() {
    if ! command -v wget &> /dev/null; then
        apt-get install -y wget || yum install -y wget
    fi
}

# ====================
# 2. 运行逻辑 (多进程 Wget)
# ====================
run_traffic() {
    # 使用 Hetzner 官方测速源 (10GB文件)，最稳，不封 IP
    URL="https://fsn1-speed.hetzner.com/10GB.bin"
    
    echo -e "${BLUE}==============================================${NC}"
    echo -e "   正在启动 ${GREEN}${CONCURRENT_NUM}${NC} 个并发进程进行消耗..."
    echo -e "   使用节点: Hetzner (德国)"
    echo -e "   ${YELLOW}注意：不再显示进度条，直接看流量统计${NC}"
    echo -e "${BLUE}==============================================${NC}"

    while true; do
        # 启动多进程后台下载
        for ((i=1; i<=CONCURRENT_NUM; i++)); do
            # -O /dev/null: 不占硬盘
            # -q: 静默模式
            # --timeout: 超时保护
            wget -O /dev/null -q --timeout=10 --tries=2 "$URL" &
        done

        # 等待这一批全部跑完 (或超时)
        wait
        
        # 统计流量 (粗略计算：4个进程 x 10GB = 40GB，但为了准确通常跑不满就会断，这里按时间估算或仅仅是为了跑流量)
        # 这里为了不误导，我们直接无限循环，不依赖文件大小统计
        echo -e "${GREEN} >> 完成一轮并发消耗 (约消耗带宽满载运行)...${NC}"
        
        # 简单防卡死
        sleep 1
    done
}

# ====================
# 3. 入口
# ====================
main() {
    clear
    # 必须以 Root 运行
    if [[ $EUID -ne 0 ]]; then
       echo -e "${RED}必须使用 root 运行！${NC}"; exit 1
    fi

    check_dep
    fix_dns # 先修 DNS
    
    echo -e "1. ${GREEN}开始跑流量${NC} (DNS修复 + 4倍速并发)"
    echo -e "0. 退出"
    read -p "回车直接开始: " choice

    case $choice in
        0) exit 0 ;;
        *) run_traffic ;;
    esac
}

main
