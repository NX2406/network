#!/bin/bash

# ==================================================
# æµé‡æ¶ˆè€—/æµ‹é€Ÿè„šæœ¬ v8.0 (æ­»å¾ªç¯ç»ˆæä¿®å¤ç‰ˆ)
# ==================================================

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
SKYBLUE='\033[0;36m'
BLUE='\033[0;34m'
NC='\033[0m'

# çº¿ç¨‹æ•° (é»˜è®¤8ï¼Œè¿‡å¤§å®¹æ˜“è¢«æ–­å¼€)
THREADS=8
# ç´¯è®¡æ¶ˆè€—æµé‡ (MB)
TOTAL_MB=0

# æ•è· Ctrl+C
trap 'echo -e "\n${RED}[!] è„šæœ¬å·²åœæ­¢ã€‚æœ¬æ¬¡è¿è¡Œå…±æ¶ˆè€—æµé‡ï¼š$(awk "BEGIN {print $TOTAL_MB/1024}") GB${NC}"; rm -f *.st; exit 1' INT

# ====================
# 1. åŸºç¡€ä¾èµ–æ£€æŸ¥
# ====================
check_dep() {
    # æ£€æŸ¥/å®‰è£… axel
    if ! command -v axel &> /dev/null; then
        echo -e "${YELLOW}æ­£åœ¨å®‰è£… axel...${NC}"
        if [ -f /etc/debian_version ]; then 
            apt-get update -y -q && apt-get install -y axel
        elif [ -f /etc/redhat-release ]; then
            yum install -y epel-release && yum install -y axel
        fi
    fi
    # æ£€æŸ¥/å®‰è£… speedtest
    if ! command -v speedtest-cli &> /dev/null; then
        echo -e "${YELLOW}æ­£åœ¨å®‰è£… speedtest-cli...${NC}"
        pip3 install speedtest-cli 2>/dev/null || apt-get install -y speedtest-cli 2>/dev/null || yum install -y speedtest-cli 2>/dev/null
    fi
    # æ£€æŸ¥ curl
    if ! command -v curl &> /dev/null; then apt-get install -y curl; fi
}

# ====================
# 2. é«˜è´¨é‡èŠ‚ç‚¹åº“ (ç²¾ç®€ä¸ºå¿…æ´»èŠ‚ç‚¹)
# ====================
# æ ¼å¼: åœ°åŒº|åç§°|URL|å¤§å°(MB)
# åªä¿ç•™å¤§å‚å®˜æ–¹ Looking Glassï¼Œå‰”é™¤æ˜“å˜èŠ‚ç‚¹
NODES=(
    "Global|Leaseweb (Global)|http://mirror.leaseweb.com/speedtest/1000mb.bin|1000"
    "EU|Hetzner (Germany)|https://fsn1-speed.hetzner.com/1GB.bin|1000"
    "EU|Hetzner (Finland)|https://hel1-speed.hetzner.com/1GB.bin|1000"
    "EU|Scaleway (France)|http://ping.online.net/1000Mo.dat|1000"
    "US|Tele2 (Generic)|http://speedtest.tele2.net/100MB.zip|100"
    "Global|OVH (Global)|http://proof.ovh.net/files/1Gb.dat|1024"
    "US|Ashburn (US)|http://speedtest.ashburn.linode.com/100MB-ashburn.bin|100"
    "JP|Tokyo (Linode)|http://speedtest.tokyo2.linode.com/100MB-tokyo2.bin|100"
)

# ====================
# 3. æ ¸å¿ƒå·¥å…·å‡½æ•°
# ====================

# é¢„æ£€æ–‡ä»¶æ˜¯å¦å¯ç”¨ (HTTP 200/301)
check_url_alive() {
    url="$1"
    # ä½¿ç”¨ curl -I (Head) æ£€æŸ¥ï¼Œè¶…æ—¶ 3 ç§’
    code=$(curl -o /dev/null --silent --head --write-out '%{http_code}\n' --max-time 3 "$url")
    if [[ "$code" == "200" ]] || [[ "$code" == "301" ]] || [[ "$code" == "302" ]]; then
        return 0 # æ´»ç€
    else
        return 1 # æ­»äº† (403/404/è¶…æ—¶)
    fi
}

display_status() {
    clear
    TOTAL_GB=$(awk "BEGIN {printf \"%.2f\", $TOTAL_MB/1024}")
    echo -e "${BLUE}#################################################${NC}"
    echo -e "${BLUE}#            æµé‡æ¶ˆè€—æŒ‚æœºè„šæœ¬ v8.0              #${NC}"
    echo -e "${BLUE}#################################################${NC}"
    echo -e "   ğŸš€ ${GREEN}æ¨¡å¼:${NC} $1"
    echo -e "   ğŸ”— ${GREEN}å½“å‰èŠ‚ç‚¹:${NC} ${SKYBLUE}$CURRENT_NODE_NAME${NC}"
    echo -e "   ğŸ“Š ${YELLOW}å·²è·‘æµé‡:${NC} ${RED}${TOTAL_GB} GB${NC}"
    echo -e "   âš¡ ${YELLOW}é€Ÿåº¦:${NC} è§ä¸‹æ–¹è¿›åº¦æ¡"
    echo -e "${BLUE}-------------------------------------------------${NC}"
}

# ====================
# 4. æ‰§è¡Œé€»è¾‘
# ====================

run_download() {
    while true; do
        # --- éšæœºé€‰ä¸€ä¸ªèŠ‚ç‚¹ ---
        RANDOM_INDEX=$((RANDOM % ${#NODES[@]}))
        node_str="${NODES[$RANDOM_INDEX]}"
        
        CURRENT_NODE_NAME=$(echo "$node_str" | cut -d'|' -f2)
        url=$(echo "$node_str" | cut -d'|' -f3)
        size=$(echo "$node_str" | cut -d'|' -f4)

        display_status "å¤šçº¿ç¨‹ä¸‹è½½ (è‡ªåŠ¨è½®è¯¢)"

        echo -e "æ­£åœ¨æ£€æµ‹èŠ‚ç‚¹å¯ç”¨æ€§: ${YELLOW}$CURRENT_NODE_NAME${NC} ..."
        
        # --- å…³é”®ä¿®å¤ï¼šå…ˆæ£€æµ‹ï¼Œåä¸‹è½½ ---
        if check_url_alive "$url"; then
            echo -e "${GREEN}èŠ‚ç‚¹æ­£å¸¸ (HTTP 200 OK)ï¼Œå¼€å§‹ä¸‹è½½...${NC}"
            
            # --- å…³é”®ä¿®å¤ï¼šåˆ é™¤ axel æ®‹ç•™æ–‡ä»¶ï¼Œé˜²æ­¢æŠ¥é”™ ---
            rm -f *.st
            filename=$(basename "$url")
            rm -f "$filename"
            
            # è¿è¡Œ axel
            # -n çº¿ç¨‹æ•°
            # -a ç®€æ´è¿›åº¦æ¡
            # -o /dev/null ç›´æ¥ä¸¢å¼ƒ
            axel -n $THREADS -a -k -o /dev/null "$url"
            
            exit_code=$?
            if [ $exit_code -eq 0 ]; then
                TOTAL_MB=$((TOTAL_MB + size))
                echo -e "${GREEN}ä¸‹è½½å®Œæˆï¼Œæµé‡å·²è®°å½•ã€‚${NC}"
            else
                echo -e "${RED}[!] ä¸‹è½½ä¸­é€”æ–­å¼€ï¼Œä¸è®¡å…¥ç»Ÿè®¡ã€‚${NC}"
            fi
        else
            echo -e "${RED}[!] èŠ‚ç‚¹ä¸å¯ç”¨ (404/403/è¶…æ—¶)ï¼Œè·³è¿‡...${NC}"
            sleep 1
        fi
        
        # å¼ºåˆ¶æ¸…ç†åƒåœ¾
        rm -f *.st
        sleep 1
    done
}

run_both() {
    while true; do
        # 1. ä¸‹è½½éƒ¨åˆ†
        RANDOM_INDEX=$((RANDOM % ${#NODES[@]}))
        node_str="${NODES[$RANDOM_INDEX]}"
        CURRENT_NODE_NAME=$(echo "$node_str" | cut -d'|' -f2)
        url=$(echo "$node_str" | cut -d'|' -f3)
        size=$(echo "$node_str" | cut -d'|' -f4)
        
        display_status "æ··åˆæ¨¡å¼ (Down+Up)"
        
        if check_url_alive "$url"; then
            echo -e "${SKYBLUE}[1/2] æ­£åœ¨ä¸‹è½½...${NC}"
            rm -f *.st
            axel -n $THREADS -a -k -o /dev/null "$url"
            if [ $? -eq 0 ]; then TOTAL_MB=$((TOTAL_MB + size)); fi
        else
            echo -e "${RED}[!] èŠ‚ç‚¹å¤±æ•ˆï¼Œè·³è¿‡ä¸‹è½½...${NC}"
        fi
        
        # 2. ä¸Šä¼ éƒ¨åˆ†
        echo -e "\n${SKYBLUE}[2/2] æ­£åœ¨ä¸Šä¼  (Speedtest)...${NC}"
        speedtest-cli --secure
        TOTAL_MB=$((TOTAL_MB + 50))
        
        rm -f *.st
        sleep 2
    done
}

# ====================
# 5. ä¸»èœå•
# ====================
main() {
    clear
    check_dep
    # å¼ºåˆ¶æ¸…ç†æ—§çš„æ®‹ç•™æ–‡ä»¶
    rm -f *.st
    
    echo -e "================================================="
    echo -e "   æµé‡æ¶ˆè€—è„šæœ¬ v8.0 (æœ€ç»ˆä¿®æ­£ç‰ˆ)"
    echo -e "================================================="
    echo -e "1. ${GREEN}å¤šçº¿ç¨‹è·‘ä¸‹è¡Œ${NC} (Axel 8çº¿ç¨‹ - æ¨è)"
    echo -e "2. ${GREEN}æ··åˆè·‘æµé‡${NC} (ä¸‹è¡Œ + Speedtestä¸Šè¡Œ)"
    echo -e "3. ${GREEN}åªè·‘ä¸Šè¡Œ${NC} (Speedtest)"
    echo -e "0. é€€å‡º"
    echo -e "================================================="
    read -p "é€‰æ‹© [1-3]: " choice

    case $choice in
        1) run_download ;;
        2) run_both ;;
        3) 
           CURRENT_NODE_NAME="Speedtest Upload"
           while true; do
               display_status "åªè·‘ä¸Šè¡Œ"
               speedtest-cli --no-download --secure
               TOTAL_MB=$((TOTAL_MB + 50))
               sleep 1
           done 
           ;;
        0) exit 0 ;;
        *) main ;;
    esac
}

main
