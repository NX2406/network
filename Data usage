#!/bin/bash

# ==================================================
# æµé‡æ¶ˆè€—/å¾ªç¯æµ‹é€Ÿè„šæœ¬ v3.0 (ä»ªè¡¨ç›˜ç‰ˆ)
# ==================================================

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
SKYBLUE='\033[0;36m'
BLUE='\033[0;34m'
NC='\033[0m'

# ç´¯è®¡æ¶ˆè€—æµé‡å˜é‡ (å•ä½: MB)
TOTAL_MB=0

# æ•è· Ctrl+C
trap 'echo -e "\n${RED}[!] è„šæœ¬å·²åœæ­¢ã€‚æœ¬æ¬¡è¿è¡Œå…±æ¶ˆè€—æµé‡ï¼š$(awk "BEGIN {print $TOTAL_MB/1024}") GB${NC}"; exit 1' INT

# ä¾èµ–æ£€æŸ¥
check_dep() {
    if ! command -v wget &> /dev/null; then
        echo -e "${YELLOW}æ­£åœ¨å®‰è£… wget...${NC}"
        if [ -f /etc/debian_version ]; then apt-get install -y wget; 
        elif [ -f /etc/redhat-release ]; then yum install -y wget; fi
    fi
    if ! command -v speedtest-cli &> /dev/null; then
        echo -e "${YELLOW}æ­£åœ¨å®‰è£… speedtest-cli...${NC}"
        pip3 install speedtest-cli 2>/dev/null || apt-get install -y speedtest-cli 2>/dev/null || yum install -y speedtest-cli 2>/dev/null
    fi
}

# æ ¼å¼åŒ–æ˜¾ç¤ºæµé‡ (MB -> GB)
display_status() {
    clear
    # è®¡ç®— GB
    TOTAL_GB=$(awk "BEGIN {printf \"%.2f\", $TOTAL_MB/1024}")
    
    echo -e "${BLUE}#################################################${NC}"
    echo -e "${BLUE}#            æµé‡æ¶ˆè€—æŒ‚æœºè„šæœ¬ v3.0              #${NC}"
    echo -e "${BLUE}#################################################${NC}"
    echo -e ""
    echo -e "   ğŸš€ ${GREEN}å½“å‰æ¨¡å¼:${NC} $1"
    echo -e "   ğŸ“Š ${YELLOW}å·²æ¶ˆè€—æ€»æµé‡:${NC} ${RED}${TOTAL_GB} GB${NC}"
    echo -e "   â±ï¸  ${SKYBLUE}è¿è¡ŒçŠ¶æ€:${NC} æ­£åœ¨è¿è¡Œä¸­ (æŒ‰ Ctrl+C åœæ­¢)"
    echo -e ""
    echo -e "${BLUE}-------------------------------------------------${NC}"
    echo -e "æ­£åœ¨æ‰§è¡Œä¸‹ä¸€è½®ä»»åŠ¡..."
}

# 1. å¦‚ä¸‹è¡Œ (å¾ªç¯ä¸‹è½½)
run_download() {
    # ä½¿ç”¨ 512MB çš„æ–‡ä»¶ï¼Œæ—¢èƒ½è·‘æ»¡å¸¦å®½ï¼Œåˆèƒ½æ¯”è¾ƒå¿«åœ°åˆ·æ–°â€œå·²æ¶ˆè€—æµé‡â€çš„ç»Ÿè®¡
    # å¤‡é€‰æºåˆ—è¡¨
    URL1="http://speedtest.tele2.net/512MB.zip"
    URL2="http://ping.online.net/500Mo.dat"
    
    SIZE_MB=512
    
    while true; do
        display_status "åªè·‘ä¸‹è¡Œ (Download)"
        
        # å°è¯•ä½¿ç”¨ URL1
        wget -O /dev/null --user-agent="Mozilla/5.0" --show-progress "$URL1"
        if [ $? -eq 0 ]; then
            TOTAL_MB=$((TOTAL_MB + SIZE_MB))
        else
            echo -e "${RED}[!] èŠ‚ç‚¹1è¿æ¥å¤±è´¥ï¼Œåˆ‡æ¢å¤‡ç”¨èŠ‚ç‚¹...${NC}"
            wget -O /dev/null --user-agent="Mozilla/5.0" --show-progress "$URL2"
            if [ $? -eq 0 ]; then
                TOTAL_MB=$((TOTAL_MB + 500))
            else
                echo -e "${RED}[!] æ‰€æœ‰èŠ‚ç‚¹å‡è¶…æ—¶ï¼Œç­‰å¾… 5 ç§’é‡è¯•...${NC}"
                sleep 5
            fi
        fi
    done
}

# 2. è·‘ä¸Šè¡Œ (Speedtest Upload)
run_upload() {
    while true; do
        display_status "åªè·‘ä¸Šè¡Œ (Upload)"
        echo -e "${YELLOW}æ­£åœ¨æµ‹é€Ÿä¸Šä¼  (ä¸ä¸‹è½½)...${NC}"
        # speedtest æ¯”è¾ƒéš¾ç²¾ç¡®ç»Ÿè®¡æµé‡ï¼ŒæŒ‰ä¸€æ¬¡å¤§æ¦‚ 50-100MB ä¼°ç®—ï¼Œæˆ–è€…åªæ˜¾ç¤ºæ¬¡æ•°
        speedtest-cli --no-download --secure
        echo -e "\n${GREEN}å®Œæˆä¸€è½®ä¸Šä¼ ï¼Œä¼‘æ¯ 2 ç§’...${NC}"
        sleep 2
        # ç®€å•ä¼°ç®—å¢åŠ ç»Ÿè®¡ (ä»…ä½œå‚è€ƒ)
        TOTAL_MB=$((TOTAL_MB + 50)) 
    done
}

# 3. æ··åˆæ¨¡å¼
run_both() {
    while true; do
        display_status "æ··åˆåŒæ‰“ (Down+Up)"
        
        echo -e "${SKYBLUE}[1/2] æ­£åœ¨ä¸‹è½½...${NC}"
        wget -O /dev/null --user-agent="Mozilla/5.0" --show-progress "http://speedtest.tele2.net/100MB.zip"
        TOTAL_MB=$((TOTAL_MB + 100))
        
        echo -e "\n${SKYBLUE}[2/2] æ­£åœ¨ä¸Šä¼ ...${NC}"
        speedtest-cli --secure
        TOTAL_MB=$((TOTAL_MB + 50))
        
        sleep 2
    done
}

# èœå•
main() {
    check_dep
    clear
    echo -e "=================================="
    echo -e "   æµé‡æ¶ˆè€—è„šæœ¬ (å¸¦ç»Ÿè®¡é¢æ¿)"
    echo -e "=================================="
    echo -e "1. ${GREEN}åªè·‘ä¸‹è¡Œ${NC} (æ¨èï¼Œæ˜¾ç¤ºè¿›åº¦æ¡)"
    echo -e "2. ${GREEN}åªè·‘ä¸Šè¡Œ${NC} (ä½¿ç”¨ Speedtest)"
    echo -e "3. ${GREEN}æ··åˆå¾ªç¯${NC}"
    echo -e "0. é€€å‡º"
    read -p "è¯·é€‰æ‹©: " choice

    case $choice in
        1) run_download ;;
        2) run_upload ;;
        3) run_both ;;
        0) exit 0 ;;
        *) main ;;
    esac
}

main
