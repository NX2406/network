#!/bin/bash

# ==================================================
# 流量消耗/测速脚本 v13.0 (内核级统计 + 进度条)
# ==================================================

# 颜色
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

# 10GB 文件源 (Hetzner)
URL="https://fsn1-speed.hetzner.com/10GB.bin"

# 自动检测主网卡接口
INTERFACE=$(ip route get 8.8.8.8 | awk 'NR==1 {print $5}')
# 记录初始字节数
START_RX=$(cat /sys/class/net/$INTERFACE/statistics/rx_bytes 2>/dev/null)
START_TX=$(cat /sys/class/net/$INTERFACE/statistics/tx_bytes 2>/dev/null)
if [ -z "$START_RX" ]; then
    # 备用方案: 从 /proc/net/dev 获取
    START_RX=$(grep "$INTERFACE" /proc/net/dev | awk '{print $2}')
    START_TX=$(grep "$INTERFACE" /proc/net/dev | awk '{print $10}')
fi

START_TIME=$(date +%s)

# 捕获 Ctrl+C
trap 'cleanup' INT

# 流量转换函数 (Bytes -> GB)
to_gb() {
    local bytes=$1
    awk "BEGIN {printf \"%.2f\", $bytes/1024/1024/1024}"
}

cleanup() {
    echo -e "\n${RED}[!] 正在停止所有任务...${NC}"
    kill $(jobs -p) 2>/dev/null
    
    # 再次读取网卡数据
    END_TIME=$(date +%s)
    END_RX=$(cat /sys/class/net/$INTERFACE/statistics/rx_bytes 2>/dev/null)
    END_TX=$(cat /sys/class/net/$INTERFACE/statistics/tx_bytes 2>/dev/null)
    if [ -z "$END_RX" ]; then
        END_RX=$(grep "$INTERFACE" /proc/net/dev | awk '{print $2}')
        END_TX=$(grep "$INTERFACE" /proc/net/dev | awk '{print $10}')
    fi

    # 计算差值
    RX_DIFF=$((END_RX - START_RX))
    TX_DIFF=$((END_TX - START_TX))
    TOTAL_BYTES=$((RX_DIFF + TX_DIFF))
    
    TOTAL_GB=$(to_gb $TOTAL_BYTES)
    DURATION=$((END_TIME - START_TIME))
    
    # 计算平均速度 (MB/s)
    if [ $DURATION -gt 0 ]; then
        AVG_SPEED=$(awk "BEGIN {printf \"%.2f\", ($TOTAL_BYTES/1024/1024)/$DURATION}")
    else
        AVG_SPEED="0"
    fi

    echo -e "${GREEN}==========================================${NC}"
    echo -e "   🏁 运行结束"
    echo -e "   ⏱️  总运行时长: ${YELLOW}${DURATION} 秒${NC}"
    echo -e "   📉 监测网卡:    ${PURPLE}${INTERFACE}${NC}"
    echo -e "   📊 实际消耗流量: ${CYAN}${TOTAL_GB} GB${NC} (真实统计)"
    echo -e "   🚀 平均流量速度: ${CYAN}${AVG_SPEED} MB/s${NC}"
    echo -e "${GREEN}==========================================${NC}"
    exit 0
}

# 1. 依赖检查
check_dep() {
    if ! command -v wget &> /dev/null; then apt-get install -y wget || yum install -y wget; fi
}

# 2. 暴力修复 DNS
fix_dns() {
    echo -e "${YELLOW}[*] 正在优化网络配置...${NC}"
    echo "nameserver 8.8.8.8" > /etc/resolv.conf
    echo "nameserver 1.1.1.1" >> /etc/resolv.conf
}

# 3. 仪表盘
show_dashboard() {
    clear
    NOW_TIME=$(date +%s)
    RUN_TIME=$((NOW_TIME - START_TIME))
    
    # 实时计算当前消耗
    CUR_RX=$(grep "$INTERFACE" /proc/net/dev | awk '{print $2}')
    CUR_TX=$(grep "$INTERFACE" /proc/net/dev | awk '{print $10}')
    CUR_TOTAL=$(( (CUR_RX - START_RX) + (CUR_TX - START_TX) ))
    CUR_GB=$(to_gb $CUR_TOTAL)

    echo -e "${BLUE}#################################################${NC}"
    echo -e "${BLUE}#        流量消耗挂机脚本 v13.0 (真实版)        #${NC}"
    echo -e "${BLUE}#################################################${NC}"
    echo -e ""
    echo -e "   🚀 ${GREEN}目标文件:${NC} Hetzner 10GB (无限循环)"
    echo -e "   ⚡ ${GREEN}并发进程:${NC} ${CYAN}${CURRENT_THREADS}${NC}"
    echo -e "   ⏱️  ${GREEN}运行时间:${NC} ${YELLOW}${RUN_TIME} 秒${NC}"
    echo -e "   📊 ${GREEN}实时流量:${NC} ${RED}${CUR_GB} GB${NC} (统计中...)"
    echo -e ""
    echo -e "${BLUE}-------------------------------------------------${NC}"
    echo -e "${PURPLE}正在全速下载中 (主线程进度):${NC}"
}

# 4. 运行逻辑
run_traffic() {
    local threads=$1
    CURRENT_THREADS=$threads
    
    show_dashboard

    while true; do
        # 启动 N-1 个后台静默进程
        for ((i=1; i<threads; i++)); do
            wget -O /dev/null -q --timeout=10 --tries=2 "$URL" &
        done
        
        # 启动 1 个前台进程 (显示进度条)
        # 这里的 output 会被直接显示在仪表盘下方
        wget -O /dev/null --progress=bar:force "$URL"
        
        # 等待本轮结束
        wait
        
        # 刷新一下仪表盘看看跑了多少
        show_dashboard
        echo -e "${GREEN} >> 完成一轮循环，立即重置...${NC}"
        sleep 1
    done
}

# 5. 主菜单
main() {
    if [[ $EUID -ne 0 ]]; then echo -e "${RED}必须 root 运行${NC}"; exit 1; fi
    check_dep
    fix_dns
    
    clear
    echo -e "================================================="
    echo -e "    流量消耗脚本 v13.0 (修复0GB显示问题)"
    echo -e "================================================="
    echo -e "1. ${GREEN}默认模式${NC} (10 线程)"
    echo -e "2. ${GREEN}自定义模式${NC} (手动输入线程数)"
    echo -e "0. 退出"
    echo -e "================================================="
    read -p "请选择: " choice

    case $choice in
        1) run_traffic 10 ;;
        2) 
            read -p "请输入线程数 (推荐 20-50): " t
            if [[ ! "$t" =~ ^[0-9]+$ ]]; then t=10; fi
            run_traffic $t 
            ;;
        *) run_traffic 10 ;;
    esac
}

main
