#!/bin/bash

# ==================================================
# æµé‡æ¶ˆè€—/æµ‹é€Ÿè„šæœ¬ v13.0 (å†…æ ¸çº§ç»Ÿè®¡ + è¿›åº¦æ¡ + æŒä¹…åŒ–ç‰ˆ)
# ==================================================

# é¢œè‰²
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

# 10GB æ–‡ä»¶æº (Hetzner)
URL="https://fsn1-speed.hetzner.com/10GB.bin"

# è‡ªåŠ¨æ£€æµ‹ä¸»ç½‘å¡æ¥å£
INTERFACE=$(ip route get 8.8.8.8 | awk 'NR==1 {print $5}')
# è®°å½•åˆå§‹å­—èŠ‚æ•°
START_RX=$(cat /sys/class/net/$INTERFACE/statistics/rx_bytes 2>/dev/null)
START_TX=$(cat /sys/class/net/$INTERFACE/statistics/tx_bytes 2>/dev/null)
if [ -z "$START_RX" ]; then
    # å¤‡ç”¨æ–¹æ¡ˆ: ä» /proc/net/dev è·å–
    START_RX=$(grep "$INTERFACE" /proc/net/dev | awk '{print $2}')
    START_TX=$(grep "$INTERFACE" /proc/net/dev | awk '{print $10}')
fi

START_TIME=$(date +%s)

# æ•è· Ctrl+C
trap 'cleanup' INT

# æµé‡è½¬æ¢å‡½æ•° (Bytes -> GB)
to_gb() {
    local bytes=$1
    awk "BEGIN {printf \"%.2f\", $bytes/1024/1024/1024}"
}

cleanup() {
    echo -e "\n${RED}[!] æ­£åœ¨åœæ­¢æ‰€æœ‰ä»»åŠ¡...${NC}"
    kill $(jobs -p) 2>/dev/null
    
    # å†æ¬¡è¯»å–ç½‘å¡æ•°æ®
    END_TIME=$(date +%s)
    END_RX=$(cat /sys/class/net/$INTERFACE/statistics/rx_bytes 2>/dev/null)
    END_TX=$(cat /sys/class/net/$INTERFACE/statistics/tx_bytes 2>/dev/null)
    if [ -z "$END_RX" ]; then
        END_RX=$(grep "$INTERFACE" /proc/net/dev | awk '{print $2}')
        END_TX=$(grep "$INTERFACE" /proc/net/dev | awk '{print $10}')
    fi

    # è®¡ç®—å·®å€¼
    RX_DIFF=$((END_RX - START_RX))
    TX_DIFF=$((END_TX - START_TX))
    TOTAL_BYTES=$((RX_DIFF + TX_DIFF))
    
    TOTAL_GB=$(to_gb $TOTAL_BYTES)
    DURATION=$((END_TIME - START_TIME))
    
    # è®¡ç®—å¹³å‡é€Ÿåº¦ (MB/s)
    if [ $DURATION -gt 0 ]; then
        AVG_SPEED=$(awk "BEGIN {printf \"%.2f\", ($TOTAL_BYTES/1024/1024)/$DURATION}")
    else
        AVG_SPEED="0"
    fi

    echo -e "${GREEN}==========================================${NC}"
    echo -e "   ğŸ è¿è¡Œç»“æŸ"
    echo -e "   â±ï¸  æ€»è¿è¡Œæ—¶é•¿: ${YELLOW}${DURATION} ç§’${NC}"
    echo -e "   ğŸ“‰ ç›‘æµ‹ç½‘å¡:    ${PURPLE}${INTERFACE}${NC}"
    echo -e "   ğŸ“Š å®é™…æ¶ˆè€—æµé‡: ${CYAN}${TOTAL_GB} GB${NC} (çœŸå®ç»Ÿè®¡)"
    echo -e "   ğŸš€ å¹³å‡æµé‡é€Ÿåº¦: ${CYAN}${AVG_SPEED} MB/s${NC}"
    echo -e "${GREEN}==========================================${NC}"
    exit 0
}

# 1. ä¾èµ–æ£€æŸ¥
check_dep() {
    if ! command -v wget &> /dev/null; then apt-get install -y wget || yum install -y wget; fi
}

# 2. æš´åŠ›ä¿®å¤ DNS
fix_dns() {
    echo -e "${YELLOW}[*] æ­£åœ¨ä¼˜åŒ–ç½‘ç»œé…ç½®...${NC}"
    echo "nameserver 8.8.8.8" > /etc/resolv.conf
    echo "nameserver 1.1.1.1" >> /etc/resolv.conf
}

# 3. ä»ªè¡¨ç›˜
show_dashboard() {
    clear
    NOW_TIME=$(date +%s)
    RUN_TIME=$((NOW_TIME - START_TIME))
    
    # å®æ—¶è®¡ç®—å½“å‰æ¶ˆè€—
    CUR_RX=$(grep "$INTERFACE" /proc/net/dev | awk '{print $2}')
    CUR_TX=$(grep "$INTERFACE" /proc/net/dev | awk '{print $10}')
    CUR_TOTAL=$(( (CUR_RX - START_RX) + (CUR_TX - START_TX) ))
    CUR_GB=$(to_gb $CUR_TOTAL)

    echo -e "${BLUE}#################################################${NC}"
    echo -e "${BLUE}#        æµé‡æ¶ˆè€—æŒ‚æœºè„šæœ¬ v13.0 (çœŸå®ç‰ˆ)        #${NC}"
    echo -e "${BLUE}#################################################${NC}"
    echo -e ""
    echo -e "   ğŸš€ ${GREEN}ç›®æ ‡æ–‡ä»¶:${NC} Hetzner 10GB (æ— é™å¾ªç¯)"
    echo -e "   âš¡ ${GREEN}å¹¶å‘è¿›ç¨‹:${NC} ${CYAN}${CURRENT_THREADS}${NC}"
    echo -e "   â±ï¸  ${GREEN}è¿è¡Œæ—¶é—´:${NC} ${YELLOW}${RUN_TIME} ç§’${NC}"
    echo -e "   ğŸ“Š ${GREEN}å®æ—¶æµé‡:${NC} ${RED}${CUR_GB} GB${NC} (ç»Ÿè®¡ä¸­...)"
    echo -e ""
    echo -e "${BLUE}-------------------------------------------------${NC}"
    echo -e "${PURPLE}æ­£åœ¨å…¨é€Ÿä¸‹è½½ä¸­ (ä¸»çº¿ç¨‹è¿›åº¦):${NC}"
}

# 4. è¿è¡Œé€»è¾‘
run_traffic() {
    local threads=$1
    CURRENT_THREADS=$threads
    
    show_dashboard

    while true; do
        # å¯åŠ¨ N-1 ä¸ªåå°é™é»˜è¿›ç¨‹
        for ((i=1; i<threads; i++)); do
            wget -O /dev/null -q --timeout=10 --tries=2 "$URL" &
        done
        
        # å¯åŠ¨ 1 ä¸ªå‰å°è¿›ç¨‹ (æ˜¾ç¤ºè¿›åº¦æ¡)
        # è¿™é‡Œçš„ output ä¼šè¢«ç›´æ¥æ˜¾ç¤ºåœ¨ä»ªè¡¨ç›˜ä¸‹æ–¹
        wget -O /dev/null --progress=bar:force "$URL"
        
        # ç­‰å¾…æœ¬è½®ç»“æŸ
        wait
        
        # åˆ·æ–°ä¸€ä¸‹ä»ªè¡¨ç›˜çœ‹çœ‹è·‘äº†å¤šå°‘
        show_dashboard
        echo -e "${GREEN} >> å®Œæˆä¸€è½®å¾ªç¯ï¼Œç«‹å³é‡ç½®...${NC}"
        sleep 1
    done
}

# 5. ä¸»èœå•
main() {
    if [[ $EUID -ne 0 ]]; then echo -e "${RED}å¿…é¡» root è¿è¡Œ${NC}"; exit 1; fi
    check_dep
    fix_dns
    
    clear
    echo -e "================================================="
    echo -e "    æµé‡æ¶ˆè€—è„šæœ¬ v13.0 (æŒä¹…åŒ–ç‰ˆ)"
    echo -e "================================================="
    echo -e "1. ${GREEN}é»˜è®¤æ¨¡å¼${NC} (10 çº¿ç¨‹)"
    echo -e "2. ${GREEN}è‡ªå®šä¹‰æ¨¡å¼${NC} (æ‰‹åŠ¨è¾“å…¥çº¿ç¨‹æ•°)"
    echo -e "0. é€€å‡º"
    echo -e "================================================="
    read -p "è¯·é€‰æ‹©: " choice

    case $choice in
        1) run_traffic 10 ;;
        2) 
            read -p "è¯·è¾“å…¥çº¿ç¨‹æ•° (æ¨è 20-50): " t
            if [[ ! "$t" =~ ^[0-9]+$ ]]; then t=10; fi
            run_traffic $t 
            ;;
        *) run_traffic 10 ;;
    esac
}

# ==================================================
# 6. æŒä¹…åŒ–ç®¡ç† (æ–°å¢åŠŸèƒ½)
# ==================================================

check_screen_installed() {
    if ! command -v screen &> /dev/null; then
        echo -e "${YELLOW}[*] æ£€æµ‹åˆ°ç³»ç»Ÿæœªå®‰è£… Screenï¼Œæ­£åœ¨å®‰è£…...${NC}"
        if [ -f /etc/redhat-release ]; then
            yum install -y screen
        else
            apt-get install -y screen
        fi
    fi
}

start_persistence() {
    # å¦‚æœå·²ç»æ˜¯åœ¨ screen ä¼šè¯é‡Œ ($STY ç¯å¢ƒå˜é‡å­˜åœ¨)ï¼Œç›´æ¥è¿è¡Œä¸»ç¨‹åº
    if [ ! -z "$STY" ]; then
        main
        exit 0
    fi

    # æ£€æŸ¥å¹¶å®‰è£… Screen
    check_screen_installed

    # ä¼šè¯åç§°
    SESSION_NAME="traffic_monitor"

    # æ£€æŸ¥æ˜¯å¦å·²æœ‰å­˜åœ¨çš„ä¼šè¯
    if screen -list | grep -q "$SESSION_NAME"; then
        echo -e "${GREEN}[+] æ£€æµ‹åˆ°å·²æœ‰åå°è¿›ç¨‹è¿è¡Œä¸­ï¼Œæ­£åœ¨é‡è¿...${NC}"
        sleep 2
        screen -r "$SESSION_NAME"
        exit 0
    fi

    # è¯¢é—®ç”¨æˆ·
    clear
    echo -e "================================================="
    echo -e "    ${YELLOW}ğŸ›¡ï¸  é˜²æ–­è¿æŒä¹…åŒ–æ¨¡å¼è®¾ç½® ğŸ›¡ï¸${NC}"
    echo -e "================================================="
    echo -e "SSH æ–­å¼€åï¼Œè„šæœ¬æ˜¯å¦éœ€è¦ç»§ç»­è¿è¡Œï¼Ÿ"
    echo -e "  [y] æ˜¯ (æ¨èï¼Œè‡ªåŠ¨è¿›å…¥ Screen åå°ç¯å¢ƒ)"
    echo -e "  [n] å¦ (æ™®é€šæ¨¡å¼ï¼ŒSSHæ–­å¼€åˆ™åœæ­¢)"
    echo -e ""
    read -p "è¯·é€‰æ‹© [y/n] (é»˜è®¤ y): " use_screen
    use_screen=${use_screen:-y}

    if [[ "$use_screen" == "y" ]]; then
        echo -e "${YELLOW}[*] æ­£åœ¨åˆ›å»ºåå°ä¼šè¯ '$SESSION_NAME'...${NC}"
        echo -e "${PURPLE}[æç¤º] è‹¥è¦ç¦»å¼€é€šè¿‡å¿«æ·é”®: Ctrl+A ç„¶åæŒ‰ D${NC}"
        sleep 2
        # åœ¨æ–°çš„ screen ä¼šè¯ä¸­é€’å½’è°ƒç”¨æœ¬è„šæœ¬
        # ä½¿ç”¨ bash "$0" ç¡®ä¿å³ä½¿è„šæœ¬æ²¡æœ‰ +x æƒé™ä¹Ÿèƒ½è¿è¡Œ
        screen -U -S "$SESSION_NAME" /bin/bash "$0"
    else
        main
    fi
}

# å¯åŠ¨å…¥å£
start_persistence
