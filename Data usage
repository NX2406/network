#!/bin/bash

# ==================================================
# æµé‡æ¶ˆè€—/å¾ªç¯æµ‹é€Ÿè„šæœ¬ v7.0 (é˜²æ­»å¾ªç¯ä¿®å¤ç‰ˆ)
# ==================================================

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
SKYBLUE='\033[0;36m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
NC='\033[0m'

# çº¿ç¨‹æ•°
THREADS=8
# ç´¯è®¡æ¶ˆè€—æµé‡ (MB)
TOTAL_MB=0
# è¿ç»­å¤±è´¥è®¡æ•°å™¨
FAIL_COUNT=0

# æ•è· Ctrl+C
trap 'echo -e "\n${RED}[!] è„šæœ¬å·²åœæ­¢ã€‚æœ¬æ¬¡è¿è¡Œå…±æ¶ˆè€—æµé‡ï¼š$(awk "BEGIN {print $TOTAL_MB/1024}") GB${NC}"; exit 1' INT

# ====================
# 1. åŸºç¡€ä¾èµ–æ£€æŸ¥
# ====================
check_dep() {
    if ! command -v axel &> /dev/null; then
        echo -e "${YELLOW}æ­£åœ¨å®‰è£… axel...${NC}"
        if [ -f /etc/debian_version ]; then 
            apt-get update -y -q && apt-get install -y axel
        elif [ -f /etc/redhat-release ]; then
            yum install -y epel-release && yum install -y axel
        fi
    fi
    if ! command -v speedtest-cli &> /dev/null; then
        echo -e "${YELLOW}æ­£åœ¨å®‰è£… speedtest-cli...${NC}"
        pip3 install speedtest-cli 2>/dev/null || apt-get install -y speedtest-cli 2>/dev/null || yum install -y speedtest-cli 2>/dev/null
    fi
    if ! command -v curl &> /dev/null; then apt-get install -y curl; fi
}

get_ip_info() {
    IP_INFO=$(curl -s --max-time 5 http://ip-api.com/line/?fields=query,country,city,isp)
    MY_IP=$(echo "$IP_INFO" | sed -n '1p')
    MY_COUNTRY=$(echo "$IP_INFO" | sed -n '2p')
    MY_CITY=$(echo "$IP_INFO" | sed -n '3p')
}

# ====================
# 2. èŠ‚ç‚¹åº“ (ç§»é™¤æ˜“å°é”/å¤±æ•ˆèŠ‚ç‚¹)
# ====================
# æ ¼å¼: åŒºåŸŸ|åç§°|URL|å¤§å°(MB)
NODES=(
    "Global|Linux Kernel CDN|https://cdn.kernel.org/pub/linux/kernel/v5.x/linux-5.1.tar.xz|100"
    "APAC|ğŸ‡¯ğŸ‡µ æ—¥æœ¬ (Linode)|http://speedtest.tokyo2.linode.com/100MB-tokyo2.bin|100"
    "APAC|ğŸ‡¸ğŸ‡¬ æ–°åŠ å¡ (Linode)|http://speedtest.singapore.linode.com/100MB-singapore.bin|100"
    "US|ğŸ‡ºğŸ‡¸ ç¾å›½ (Leaseweb)|http://mirror.leaseweb.com/speedtest/1000mb.bin|1000"
    "US|ğŸ‡ºğŸ‡¸ ç¾å›½ (Hetzner)|https://ash-speed.hetzner.com/1GB.bin|1000"
    "EU|ğŸ‡©ğŸ‡ª å¾·å›½ (Hetzner)|https://fsn1-speed.hetzner.com/1GB.bin|1000"
    "EU|ğŸ‡«ğŸ‡· æ³•å›½ (Scaleway)|http://ping.online.net/1000Mo.dat|1000"
    "EU|ğŸ‡³ğŸ‡± è·å…° (Tele2)|http://speedtest.tele2.net/1GB.zip|1024"
    "EU|ğŸ‡¬ğŸ‡§ è‹±å›½ (ThinkBroadband)|http://ipv4.download.thinkbroadband.com/1GB.zip|1024"
    "Global|OVH (Global)|http://proof.ovh.net/files/1Gb.dat|1024"
)

BEST_URL=""
BEST_NAME=""
BEST_SIZE=""
MODE_SWITCHED=0

# ====================
# 3. æ™ºèƒ½ä¼˜é€‰ (å¸¦è¶…æ—¶ä¿æŠ¤)
# ====================
select_best_node() {
    echo -e "\n${PURPLE}ğŸ” æ­£åœ¨ä¼˜é€‰èŠ‚ç‚¹ (Smart Select)...${NC}"
    min_ping=9999
    best_index=0
    
    for i in "${!NODES[@]}"; do
        node_str="${NODES[$i]}"
        name=$(echo "$node_str" | cut -d'|' -f2)
        url=$(echo "$node_str" | cut -d'|' -f3)
        domain=$(echo "$url" | awk -F/ '{print $3}')
        
        # Ping ä¼˜åŒ–ï¼šè¶…æ—¶0.5ç§’ï¼Œåªpingä¸€æ¬¡
        ping_val=$(ping -c 1 -W 1 "$domain" | grep 'time=' | awk -F'time=' '{print $2}' | awk '{print $1}' | cut -d. -f1)
        
        if [[ -z "$ping_val" ]]; then
            echo -e "   $name \t -> ${RED}è¶…æ—¶${NC}"
        else
            echo -e "   $name \t -> ${GREEN}${ping_val} ms${NC}"
            if [ "$ping_val" -lt "$min_ping" ]; then
                min_ping=$ping_val
                best_index=$i
            fi
        fi
    done

    best_node="${NODES[$best_index]}"
    BEST_NAME=$(echo "$best_node" | cut -d'|' -f2)
    BEST_URL=$(echo "$best_node" | cut -d'|' -f3)
    BEST_SIZE=$(echo "$best_node" | cut -d'|' -f4)
    
    echo -e "âœ… é€‰ä¸­: ${SKYBLUE}$BEST_NAME${NC}"
    sleep 1
}

# éšæœºè·å–èŠ‚ç‚¹ (Fallback)
get_random_node() {
    RANDOM_INDEX=$((RANDOM % ${#NODES[@]}))
    node_str="${NODES[$RANDOM_INDEX]}"
    BEST_NAME="éšæœº: $(echo "$node_str" | cut -d'|' -f2)"
    BEST_URL=$(echo "$node_str" | cut -d'|' -f3)
    BEST_SIZE=$(echo "$node_str" | cut -d'|' -f4)
}

# ====================
# 4. ä»ªè¡¨ç›˜
# ====================
display_status() {
    clear
    TOTAL_GB=$(awk "BEGIN {printf \"%.2f\", $TOTAL_MB/1024}")
    
    echo -e "${BLUE}#################################################${NC}"
    echo -e "${BLUE}#      æµé‡æ¶ˆè€—æŒ‚æœºè„šæœ¬ v7.0 (ä¿®å¤ç‰ˆ)           #${NC}"
    echo -e "${BLUE}#################################################${NC}"
    echo -e "   ğŸ“ ${PURPLE}ä½ç½®:${NC} $MY_COUNTRY - $MY_CITY"
    echo -e "   ğŸš€ ${GREEN}æ¨¡å¼:${NC} $1"
    echo -e "   ğŸ”— ${GREEN}èŠ‚ç‚¹:${NC} ${SKYBLUE}$BEST_NAME${NC}"
    echo -e "   ğŸ“Š ${YELLOW}æ€»é‡:${NC} ${RED}${TOTAL_GB} GB${NC}"
    
    if [ $FAIL_COUNT -gt 0 ]; then
        echo -e "   âš ï¸ ${RED}è¿ç»­å¤±è´¥æ¬¡æ•°: $FAIL_COUNT${NC}"
    fi
    
    echo -e "${BLUE}-------------------------------------------------${NC}"
}

# ====================
# 5. æ‰§è¡Œé€»è¾‘
# ====================
run_smart_logic() {
    # é¦–æ¬¡è¿è¡Œå…ˆä¼˜é€‰
    select_best_node
    
    while true; do
        # å¦‚æœè¿ç»­å¤±è´¥è¶…è¿‡2æ¬¡ï¼Œåˆ‡æ¢åˆ°éšæœºæ¨¡å¼é˜²æ­¢æ­»å¾ªç¯
        if [ $FAIL_COUNT -ge 2 ]; then
            MODE_SWITCHED=1
            get_random_node
            display_status "è‡ªåŠ¨éšæœº (æ•…éšœè½¬ç§»)"
        else
            if [ $MODE_SWITCHED -eq 0 ]; then
                display_status "æ™ºèƒ½ä¼˜é€‰ (Smart)"
            else
                get_random_node
                display_status "éšæœºè½®è¯¢ (Random)"
            fi
        fi
        
        echo -e "æ­£åœ¨ä¸‹è½½: ${SKYBLUE}$BEST_URL${NC}"
        
        # axel è¿è¡Œ
        axel -n $THREADS -a -k -o /dev/null "$BEST_URL"
        
        # æ£€æŸ¥ç»“æœ
        if [ $? -eq 0 ]; then
            TOTAL_MB=$((TOTAL_MB + BEST_SIZE))
            FAIL_COUNT=0 # æˆåŠŸåˆ™é‡ç½®å¤±è´¥è®¡æ•°
        else
            echo -e "${RED}[!] ä¸‹è½½å¤±è´¥ (HTTP Error/Timeout)${NC}"
            FAIL_COUNT=$((FAIL_COUNT + 1))
            
            if [ $FAIL_COUNT -ge 2 ]; then
                echo -e "${RED}[!] æ£€æµ‹åˆ°ä¼˜é€‰èŠ‚ç‚¹ä¸å¯ç”¨ï¼Œæ­£åœ¨åˆ‡æ¢åˆ°éšæœºå¤‡ç”¨èŠ‚ç‚¹...${NC}"
                sleep 2
            else
                echo -e "${YELLOW}æ­£åœ¨é‡è¯•...${NC}"
                sleep 1
            fi
        fi
        
        # æ¯æ¬¡ä¸‹è½½å®Œç¨å¾®ä¼‘æ¯ä¸€ä¸‹ï¼Œé˜²æ­¢CPUè¿‡çƒ­
        sleep 1
    done
}

run_both() {
    select_best_node
    while true; do
        if [ $FAIL_COUNT -ge 2 ]; then get_random_node; fi
        
        display_status "æ··åˆæ¨¡å¼"
        echo -e "${SKYBLUE}[1/2] ä¸‹è½½ä¸­...${NC}"
        axel -n $THREADS -a -k -o /dev/null "$BEST_URL"
        if [ $? -eq 0 ]; then 
            TOTAL_MB=$((TOTAL_MB + BEST_SIZE))
            FAIL_COUNT=0 
        else
            FAIL_COUNT=$((FAIL_COUNT + 1))
        fi
        
        echo -e "\n${SKYBLUE}[2/2] ä¸Šä¼ ä¸­...${NC}"
        speedtest-cli --secure
        TOTAL_MB=$((TOTAL_MB + 50))
        sleep 2
    done
}

# ====================
# 6. å…¥å£
# ====================
main() {
    clear
    check_dep
    get_ip_info
    
    echo -e "================================================="
    echo -e "   æµé‡æ¶ˆè€—è„šæœ¬ v7.0 (Smart Failover)"
    echo -e "   å½“å‰ä½ç½®: ${GREEN}$MY_COUNTRY${NC}"
    echo -e "================================================="
    echo -e "1. ${GREEN}æ™ºèƒ½ä¼˜é€‰ä¸‹è¡Œ${NC} (å¤±è´¥è‡ªåŠ¨åˆ‡æ¢éšæœºï¼Œé˜²å¡æ­»)"
    echo -e "2. ${GREEN}æ™ºèƒ½æ··åˆæ¨¡å¼${NC}"
    echo -e "3. ${GREEN}åªè·‘ä¸Šè¡Œ${NC}"
    echo -e "0. é€€å‡º"
    echo -e "================================================="
    read -p "é€‰æ‹© [1-3]: " choice

    case $choice in
        1) run_smart_logic ;;
        2) run_both ;;
        3) 
           BEST_NAME="Speedtest Upload"
           while true; do
               display_status "åªè·‘ä¸Šè¡Œ"
               speedtest-cli --no-download --secure
               TOTAL_MB=$((TOTAL_MB + 50))
               sleep 1
           done 
           ;;
        0) exit 0 ;;
        *) main ;;
    esac
}

main
