#!/bin/bash

# ==================================================
# æµé‡æ¶ˆè€—/å¾ªç¯æµ‹é€Ÿè„šæœ¬ v6.0 (æ™ºèƒ½ä¼˜é€‰ + äºšå¤ªèŠ‚ç‚¹)
# ==================================================

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
SKYBLUE='\033[0;36m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
NC='\033[0m'

# çº¿ç¨‹æ•° (Axel)
THREADS=8
# ç´¯è®¡æ¶ˆè€—æµé‡ (MB)
TOTAL_MB=0

# æ•è· Ctrl+C
trap 'echo -e "\n${RED}[!] è„šæœ¬å·²åœæ­¢ã€‚æœ¬æ¬¡è¿è¡Œå…±æ¶ˆè€—æµé‡ï¼š$(awk "BEGIN {print $TOTAL_MB/1024}") GB${NC}"; exit 1' INT

# ====================
# 1. åŸºç¡€ä¾èµ–æ£€æŸ¥
# ====================
check_dep() {
    # æ£€æŸ¥ axel
    if ! command -v axel &> /dev/null; then
        echo -e "${YELLOW}æ­£åœ¨å®‰è£… axel (å¤šçº¿ç¨‹ä¸‹è½½å™¨)...${NC}"
        if [ -f /etc/debian_version ]; then 
            apt-get update -y -q && apt-get install -y axel
        elif [ -f /etc/redhat-release ]; then
            yum install -y epel-release && yum install -y axel
        fi
    fi
    # æ£€æŸ¥ speedtest
    if ! command -v speedtest-cli &> /dev/null; then
        echo -e "${YELLOW}æ­£åœ¨å®‰è£… speedtest-cli...${NC}"
        pip3 install speedtest-cli 2>/dev/null || apt-get install -y speedtest-cli 2>/dev/null || yum install -y speedtest-cli 2>/dev/null
    fi
    # æ£€æŸ¥ curl
    if ! command -v curl &> /dev/null; then apt-get install -y curl || yum install -y curl; fi
}

# ====================
# 2. IP ä¿¡æ¯æ£€æµ‹
# ====================
get_ip_info() {
    echo -e "${BLUE}æ­£åœ¨è·å– IP ä¿¡æ¯...${NC}"
    # ä½¿ç”¨ ip-api.com è·å–ä¿¡æ¯ (çº¯æ–‡æœ¬æ ¼å¼)
    IP_INFO=$(curl -s http://ip-api.com/line/?fields=query,country,city,isp)
    
    MY_IP=$(echo "$IP_INFO" | sed -n '1p')
    MY_COUNTRY=$(echo "$IP_INFO" | sed -n '2p')
    MY_CITY=$(echo "$IP_INFO" | sed -n '3p')
    MY_ISP=$(echo "$IP_INFO" | sed -n '4p')
}

# ====================
# 3. èŠ‚ç‚¹åº“ (å…¨çƒ + äºšå¤ªä¼˜åŒ–)
# ====================
# æ ¼å¼: åŒºåŸŸ|ä½ç½®|URL|å¤§å°(MB)
NODES=(
    # --- äºšå¤ª (APAC) ---
    "APAC|ğŸ‡¯ğŸ‡µ æ—¥æœ¬(Linode)|http://speedtest.tokyo2.linode.com/100MB-tokyo2.bin|100"
    "APAC|ğŸ‡¯ğŸ‡µ æ—¥æœ¬(Softlayer)|http://speedtest.tok02.softlayer.com/downloads/test500.zip|500"
    "APAC|ğŸ‡¸ğŸ‡¬ æ–°åŠ å¡(DO)|http://speedtest-sgp1.digitalocean.com/100mb.test|100"
    "APAC|ğŸ‡¸ğŸ‡¬ æ–°åŠ å¡(Linode)|http://speedtest.singapore.linode.com/100MB-singapore.bin|100"
    "APAC|ğŸŒ å°æ¹¾(Cloudflare)|https://speed.cloudflare.com/__down?bytes=100000000|100"
    
    # --- ç¾æ´² (Americas) ---
    "US|ğŸ‡ºğŸ‡¸ ç¾å›½(DigitalOcean)|http://speedtest-nyc1.digitalocean.com/1gb.test|1024"
    "US|ğŸ‡ºğŸ‡¸ ç¾å›½(Leaseweb)|http://mirror.leaseweb.com/speedtest/1000mb.bin|1000"
    "US|ğŸ‡ºğŸ‡¸ ç¾å›½(Vultr)|https://sjo-ca-us-ping.vultr.com/vultr.com.1000MB.bin|1000"
    
    # --- æ¬§æ´² (Europe) ---
    "EU|ğŸ‡©ğŸ‡ª å¾·å›½(Hetzner)|https://fsn1-speed.hetzner.com/1GB.bin|1000"
    "EU|ğŸ‡«ğŸ‡· æ³•å›½(Online)|http://ping.online.net/1000Mo.dat|1000"
    "EU|ğŸ‡³ğŸ‡± è·å…°(Tele2)|http://speedtest.tele2.net/1GB.zip|1024"
    "EU|ğŸ‡¬ğŸ‡§ è‹±å›½(ThinkBroadband)|http://ipv4.download.thinkbroadband.com/1GB.zip|1024"
)

# å½“å‰é€‰ä¸­çš„æœ€ä½³èŠ‚ç‚¹å˜é‡
BEST_URL=""
BEST_NAME=""
BEST_SIZE=""

# ====================
# 4. æ™ºèƒ½ä¼˜é€‰é€»è¾‘ (Smart Select)
# ====================
select_best_node() {
    echo -e "\n${PURPLE}ğŸ” æ­£åœ¨è¿›è¡Œå…¨èŠ‚ç‚¹å»¶è¿Ÿæµ‹è¯• (Smart Select)...${NC}"
    echo -e "${YELLOW}-------------------------------------------------${NC}"
    
    min_ping=9999
    best_index=0
    
    # éå†æ‰€æœ‰èŠ‚ç‚¹
    for i in "${!NODES[@]}"; do
        node_str="${NODES[$i]}"
        # è§£æå­—ç¬¦ä¸²
        region=$(echo "$node_str" | cut -d'|' -f1)
        name=$(echo "$node_str" | cut -d'|' -f2)
        url=$(echo "$node_str" | cut -d'|' -f3)
        
        # æå–åŸŸåè¿›è¡Œ Ping
        domain=$(echo "$url" | awk -F/ '{print $3}')
        
        # Ping 1æ¬¡ï¼Œè¶…æ—¶ 1ç§’ (å¿«é€Ÿç­›é€‰)
        ping_val=$(ping -c 1 -W 1 "$domain" | grep 'time=' | awk -F'time=' '{print $2}' | awk '{print $1}' | cut -d. -f1)
        
        if [[ -z "$ping_val" ]]; then
            ping_val=9999 # è¶…æ—¶
            echo -e "   $name \t -> ${RED}è¶…æ—¶/ä¸å¯è¾¾${NC}"
        else
            echo -e "   $name \t -> ${GREEN}${ping_val} ms${NC}"
            # æ¯”è¾ƒæœ€å°å€¼
            if [ "$ping_val" -lt "$min_ping" ]; then
                min_ping=$ping_val
                best_index=$i
            fi
        fi
    done

    # è®¾ç½®æœ€ä½³èŠ‚ç‚¹
    best_node="${NODES[$best_index]}"
    BEST_NAME=$(echo "$best_node" | cut -d'|' -f2)
    BEST_URL=$(echo "$best_node" | cut -d'|' -f3)
    BEST_SIZE=$(echo "$best_node" | cut -d'|' -f4)
    
    echo -e "${YELLOW}-------------------------------------------------${NC}"
    echo -e "âœ… ä¼˜é€‰ç»“æœ: ${SKYBLUE}$BEST_NAME${NC} (å»¶è¿Ÿ: ${min_ping}ms)"
    sleep 2
}

# ====================
# 5. ä»ªè¡¨ç›˜
# ====================
display_status() {
    clear
    TOTAL_GB=$(awk "BEGIN {printf \"%.2f\", $TOTAL_MB/1024}")
    
    echo -e "${BLUE}#################################################${NC}"
    echo -e "${BLUE}#         æµé‡æ¶ˆè€—æŒ‚æœºè„šæœ¬ v6.0 (æ™ºèƒ½ç‰ˆ)        #${NC}"
    echo -e "${BLUE}#################################################${NC}"
    echo -e ""
    echo -e "   ğŸ“ ${PURPLE}æœ¬æœº IP:${NC}   $MY_IP ($MY_CITY, $MY_COUNTRY)"
    echo -e "   ğŸ¢ ${PURPLE}è¿è¥å•†:${NC}    $MY_ISP"
    echo -e ""
    echo -e "   ğŸš€ ${GREEN}å½“å‰æ¨¡å¼:${NC} $1"
    echo -e "   ğŸ”— ${GREEN}å½“å‰èŠ‚ç‚¹:${NC} ${SKYBLUE}$BEST_NAME${NC}"
    echo -e "   âš¡ ${YELLOW}å¹¶å‘çº¿ç¨‹:${NC} ${THREADS}"
    echo -e "   ğŸ“Š ${YELLOW}æ¶ˆè€—æ€»é‡:${NC} ${RED}${TOTAL_GB} GB${NC}"
    echo -e "   â±ï¸  ${SKYBLUE}è¿è¡ŒçŠ¶æ€:${NC} è¿è¡Œä¸­... (Ctrl+C åœæ­¢)"
    echo -e ""
    echo -e "${BLUE}-------------------------------------------------${NC}"
}

# ====================
# 6. è¿è¡Œé€»è¾‘
# ====================

# åªè·‘ä¸‹è¡Œ (ä½¿ç”¨ä¼˜é€‰èŠ‚ç‚¹)
run_download_smart() {
    # å…ˆè¿è¡Œä¸€æ¬¡é€‰è·¯
    select_best_node
    
    while true; do
        display_status "æ™ºèƒ½ä¸‹è¡Œ (Smart Download)"
        
        # è°ƒç”¨ axel ä¸‹è½½
        echo -e "æ­£åœ¨å…¨é€Ÿä¸‹è½½: ${SKYBLUE}$BEST_URL${NC}"
        axel -n $THREADS -a -k -o /dev/null "$BEST_URL"
        
        if [ $? -eq 0 ]; then
            TOTAL_MB=$((TOTAL_MB + BEST_SIZE))
        else
            echo -e "${RED}[!] è¿æ¥ä¸­æ–­ï¼Œé‡æ–°ä¼˜é€‰èŠ‚ç‚¹...${NC}"
            sleep 1
            select_best_node # å¦‚æœä¸‹è½½å¤±è´¥ï¼Œé‡æ–°é€‰è·¯
        fi
    done
}

# æ··åˆæ¨¡å¼ (ä¼˜é€‰ä¸‹è¡Œ + Speedtestä¸Šè¡Œ)
run_both_smart() {
    select_best_node
    while true; do
        display_status "æ™ºèƒ½æ··åˆ (Smart Mix)"
        
        # 1. ä¸‹è½½
        echo -e "${SKYBLUE}[1/2] æ­£åœ¨ä¸‹è½½...${NC}"
        axel -n $THREADS -a -k -o /dev/null "$BEST_URL"
        TOTAL_MB=$((TOTAL_MB + BEST_SIZE))
        
        # 2. ä¸Šä¼ 
        echo -e "\n${SKYBLUE}[2/2] æ­£åœ¨ä¸Šä¼ (Speedtest)...${NC}"
        speedtest-cli --secure
        TOTAL_MB=$((TOTAL_MB + 50))
        
        sleep 2
    done
}

# ====================
# 7. ä¸»èœå•
# ====================
main() {
    clear
    check_dep
    get_ip_info
    
    echo -e "================================================="
    echo -e "   æµé‡æ¶ˆè€—/æµ‹é€Ÿå·¥å…· v6.0"
    echo -e "   å½“å‰ä½ç½®: ${GREEN}$MY_COUNTRY - $MY_CITY${NC}"
    echo -e "================================================="
    echo -e "1. ${GREEN}æ™ºèƒ½ä¼˜é€‰ä¸‹è¡Œ${NC} (è‡ªåŠ¨Pingæµ‹é€Ÿï¼Œé€‰æœ€è¿‘èŠ‚ç‚¹ï¼Œæœ€å¿«)"
    echo -e "2. ${GREEN}æ™ºèƒ½æ··åˆæ¨¡å¼${NC} (ä¼˜é€‰ä¸‹è¡Œ + Speedtestä¸Šä¼ )"
    echo -e "3. ${GREEN}åªè·‘ä¸Šè¡Œ${NC} (Speedtest Upload)"
    echo -e "0. é€€å‡º"
    echo -e "================================================="
    read -p "è¯·é€‰æ‹©åŠŸèƒ½ [1-3]: " choice

    case $choice in
        1) run_download_smart ;;
        2) run_both_smart ;;
        3) 
           # ä¸Šè¡Œæ¨¡å¼ä¸éœ€è¦ä¼˜é€‰ä¸‹è½½èŠ‚ç‚¹
           BEST_NAME="Speedtest Upload"
           while true; do
               display_status "åªè·‘ä¸Šè¡Œ"
               speedtest-cli --no-download --secure
               TOTAL_MB=$((TOTAL_MB + 50))
               sleep 1
           done
           ;;
        0) exit 0 ;;
        *) main ;;
    esac
}

main
